#!/usr/bin/env python3\n\"\"\"\nExample 3: Blockchain Storage Operations\n\nThis example shows how to:\n1. Create a blockchain database\n2. Store UTXOs\n3. Query balances\n4. Store node state\n5. Get blockchain statistics\n\"\"\"\n\nimport sys\nimport os\nsys.path.insert(0, '..')\n\nfrom meshchain.storage import BlockchainStorage\nfrom meshchain.utxo import UTXO\nfrom meshchain.crypto import StealthAddress\n\n\ndef main():\n    print(\"=\" * 60)\n    print(\"MeshChain Example 3: Blockchain Storage\")\n    print(\"=\" * 60)\n    \n    # Use in-memory database for this example\n    db_path = \":memory:\"\n    \n    # Step 1: Create storage\n    print(\"\\n1. Creating blockchain storage...\")\n    storage = BlockchainStorage(db_path)\n    print(f\"   Storage initialized (in-memory database)\")\n    \n    # Step 2: Create stealth addresses\n    print(\"\\n2. Creating stealth addresses...\")\n    alice = StealthAddress()\n    bob = StealthAddress()\n    \n    alice_addr = alice.get_address()\n    bob_addr = bob.get_address()\n    \n    print(f\"   Alice: {alice_addr.hex()}\")\n    print(f\"   Bob: {bob_addr.hex()}\")\n    \n    # Step 3: Add UTXOs to storage\n    print(\"\\n3. Adding UTXOs to storage...\")\n    \n    # Create UTXOs\n    utxos = [\n        UTXO(\n            utxo_id=b'\\x01' * 16,\n            amount=5000,\n            stealth_address=alice_addr,\n            block_height=1\n        ),\n        UTXO(\n            utxo_id=b'\\x02' * 16,\n            amount=3000,\n            stealth_address=alice_addr,\n            block_height=2\n        ),\n        UTXO(\n            utxo_id=b'\\x03' * 16,\n            amount=10000,\n            stealth_address=bob_addr,\n            block_height=2\n        ),\n    ]\n    \n    for i, utxo in enumerate(utxos, 1):\n        storage.add_utxo(utxo)\n        print(f\"   Added UTXO {i}: {utxo.amount} satoshis\")\n    \n    # Step 4: Query balances\n    print(\"\\n4. Querying balances...\")\n    alice_balance = storage.get_balance(alice_addr)\n    bob_balance = storage.get_balance(bob_addr)\n    \n    print(f\"   Alice balance: {alice_balance} satoshis\")\n    print(f\"   Bob balance: {bob_balance} satoshis\")\n    \n    # Step 5: Get unspent UTXOs\n    print(\"\\n5. Getting unspent UTXOs...\")\n    alice_utxos = storage.get_unspent_utxos(alice_addr)\n    bob_utxos = storage.get_unspent_utxos(bob_addr)\n    \n    print(f\"   Alice has {len(alice_utxos)} unspent UTXOs\")\n    print(f\"   Bob has {len(bob_utxos)} unspent UTXOs\")\n    \n    # Step 6: Spend a UTXO\n    print(\"\\n6. Spending a UTXO...\")\n    storage.spend_utxo(b'\\x01' * 16)\n    print(f\"   Spent UTXO 1\")\n    \n    # Step 7: Check updated balance\n    print(\"\\n7. Checking updated balance...\")\n    alice_balance = storage.get_balance(alice_addr)\n    print(f\"   Alice's new balance: {alice_balance} satoshis\")\n    \n    # Step 8: Store node state\n    print(\"\\n8. Storing node state...\")\n    storage.set_state(\"last_block_height\", \"2\")\n    storage.set_state(\"network_id\", \"meshchain-testnet\")\n    storage.set_state(\"node_id\", \"node-001\")\n    print(f\"   Stored node state\")\n    \n    # Step 9: Retrieve node state\n    print(\"\\n9. Retrieving node state...\")\n    last_height = storage.get_state(\"last_block_height\")\n    network_id = storage.get_state(\"network_id\")\n    node_id = storage.get_state(\"node_id\")\n    \n    print(f\"   Last block height: {last_height}\")\n    print(f\"   Network ID: {network_id}\")\n    print(f\"   Node ID: {node_id}\")\n    \n    # Step 10: Get statistics\n    print(\"\\n10. Getting blockchain statistics...\")\n    stats = storage.get_statistics()\n    \n    print(f\"   Blocks: {stats['blocks']}\")\n    print(f\"   Transactions: {stats['transactions']}\")\n    print(f\"   UTXOs: {stats['utxos']}\")\n    print(f\"   Total value: {stats['total_value']} satoshis\")\n    \n    # Step 11: Add and retrieve a peer\n    print(\"\\n11. Managing peers...\")\n    storage.add_peer(b'\\x01' * 8, 1234567890, hop_distance=2)\n    storage.add_peer(b'\\x02' * 8, 1234567891, hop_distance=3)\n    \n    peers = storage.get_peers()\n    print(f\"   Added {len(peers)} peers\")\n    for node_id, last_seen, hop_dist in peers:\n        print(f\"     Node {node_id.hex()}: hop distance {hop_dist}\")\n    \n    # Step 12: Close storage\n    print(\"\\n12. Closing storage...\")\n    storage.close()\n    print(f\"   Storage closed\")\n    \n    print(\"\\n\" + \"=\" * 60)\n    print(\"Blockchain storage example completed!\")\n    print(\"=\" * 60)\n\n\nif __name__ == \"__main__\":\n    main()\n
